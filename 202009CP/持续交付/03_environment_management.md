#### 基本环境

目前互联网公司常见的环境模型一般分为开发环境，功能测试环境，验收测试环境，预发布环境，生产环境这五个大套环境

* 开发环境：微服务架构下，单机已经无法完整地运行业务应用，这就需要开发环境内包含一套完整的业
务应用依赖以及相关的基础设施，以保证业务开发同学能在本地完成开发测试。

* 功能测试环境：在开发环境下，每个下游依赖应用都只有一个可用的 stable 版本。而在实际的开发过程
中，由于项目的并行开发，往往会同时存在多个可依赖的版本。而每个项目组的同学在测试时，都希望测试过程中的关键依赖应用是可以被独占的，版本是固定的，不会被其他项目组干扰。所以，一套独立的功能测试环境就很有必要了。通常，互联网企业会通过中间件的方式分割出一块隔离区域，在功能测试环境中创建多个子环境来解决这个问题。

* 验收测试环境：验收测试环境和功能测试环境是完全隔离的。当功能测试通过后，你可以在验收测试环境进
行最终的验收。它除了可以用作测试之外，还可以用作产品展示。所以，除了测试和开发人员，产品经理也
是验收测试环境的主要使用者。

* staging  预发布环境：到了预发布阶段，应用已经进入了生产网络，和真实的生产应用共享同一套数据库等基础设施。预发布是正式发布前的最后一次测试，在这个环境中往往可以发现线下环境中发现不了的 Bug。这个环境的运维标准等同于生产环境，一般不允许开发人员直接登录机器。

一种比较常见的方式是，将金丝雀发布作为预发布，从接入真实流量的集群中挑选一台或一小组机器先进行版本更新，通过手工测试以及自动化测试和监控系统验证，降低新版本发布的风险。
另一种做法是，独立出一组始终不接入真实流量的机器，调用在预发布环境中形成闭环。


* production环境：生产环境是用户真实使用的环境，对安全性和稳定性的要求最高


1. 开发环境的用户是开发同学；
2. 功能测试环境的主要用户是测试同学；
3. 验收测试环境的用户是产品经理和测试同学；
4. 预发布环境的使用者是测试同学，但收益者却是运维同学。


#### 环境标准化

1. 规定公司的主流语言栈；
2. 统一服务器安装镜像；
3. 提供默认的运行时配置模板；
4. 统一基础软件的版本，以及更新方式；
5. 在架构层面统一解决环境路由问题；
6. 自动化环境产生过程。



#### 容器和虚拟机的主要差异，包括三个方面：
* 首先，多个容器可以共享同一个宿主机的内核，所以容器的体积要比虚拟机小很多，这就使得容器在分发和存储上比较有优势；
* 其次，启动容器不需要启动整个操作系统，所以容器部署和启动速度更快、开销更小，也更容易迁移，这使得容器拥有更强的恢复能力；
* 最后，容器连带代码和环境一起部署的方式，保证了它所包含的程序的运行依赖不会被变更，这就使得容器有效解决了不同环境不同结果的问题

容器技术统一了软件环境和软件代码，交付产物中既包括了软件环境，又包括了软件代码。也就是说，容器帮我们重新定义了交付标准。

第一，交付结果一致
容器镜像可以把软件的运行环境以及代码打包在一起，因此可以基于同一个镜像，在不同的地方生成一模一样的运行环境，也就是说单个镜像的交付结果不可变。当然，单个容器只能提供一个服务，而实际场景下，应用都是跑在SOA 或微服务的框架下的。所以，还需要利用如 Mesos 或 Kubernetes 这样的编排系统，将多个容器组织起来，并固化编排过程。基于这两个特性，一旦形成了固定的容器镜像和对应的编排（也成为应用模板），那在不同的环境下，一定可以重复部署，且部署结果保持一致。

第二，交付自动化
容器镜像及容器编排技术很好地解决了 CI 和 CD 问题：CI 方面，与传统方式的不同只在于，原先交付的是安装包或软件包，而容器交付的则是镜像；CD 方面，与传统方式相比则有了长足的进步。对传统方式而言，部署和安装方式与软件类型、开发方式有直接关系，存在多种多样的可能。而容器技术则没有这样的问题，唯一的方式就是拉起容器镜像。这就大大简化了部署的复杂度，而且在编排系统的支持下，完成 CD 越来越容易了。

第三，交付个性化
传统的交付模式，往往因为环境的初始化问题，只能完成有限种类的交付。运维部门很难为所有的应用做出统一的环境模板，比如需要哪些软件依赖、需要哪些系统配置、部署的步骤是怎样的等等，要统一这些模板，就需要协调多个部门共同完成，难度可想而知。对于一些受众比较少的程序语言，或者一个仅仅想部署一套开源软件的需求是很难满足的，大多数情况下，需要用户自己去申请虚拟机，然后按照官方提供的文档一步一步安装环境。这样操作，非常麻烦，更别提后续的更新了。但是，有了容器之后，我们可以使用统一的接口完成任何应用的部署，几乎可以很好地满足所有的个性化需求。

第四，交付版本控制
对于容器来说，遵循的是不可变基础设施（Immutable Infrastructure）的理念，也就是说任何变化，包括代码、环境、配置的变更，都需要重新制作镜像，产生一个新的版本。这与版本往往只和代码变更有关的传统方式有所不同。


不可变基础设施模式的好处显而易见，主要包括以下三个方面：
1. 很多与 runtime 相关的配置工作都可以被简化，这让持续集成与持续部署过程变得更流畅。
2. 它也更易于应对部署环境间的差异及版本，进行更有效、全面的管理。
3. 对回滚来说，更是得到了充分的保证，只要原先版本的镜像存在，它就一定能被恢复。
